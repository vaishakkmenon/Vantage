name: Vantage CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
    # Don't run CI if ONLY these files are changed
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  WORKING_DIR: ./backend

permissions:
  contents: write

jobs:
  check:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    - name: Check Formatting
      working-directory: ${{ env.WORKING_DIR }}
      run: cargo fmt -- --check
    - name: Clippy
      working-directory: ${{ env.WORKING_DIR }}
      run: cargo clippy --features "load_magic deterministic_zobrist" -- -D warnings

  test:
    name: Test (${{ matrix.os }})
    needs: check
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
      with:
        workspaces: backend -> target
    - name: Run Tests
      working-directory: ${{ env.WORKING_DIR }}
      run: cargo test --release --features "load_magic deterministic_zobrist" -- --test-threads=1

  release:
    name: Release (${{ matrix.os }})
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: vantage-windows-x86_64.zip
            binary_path: backend/target/release/vantage.exe
            exe_name: vantage.exe
          - os: ubuntu-latest
            artifact_name: vantage-linux-x86_64.tar.gz
            binary_path: backend/target/release/vantage
            exe_name: vantage
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    
    - name: Build Release
      working-directory: ${{ env.WORKING_DIR }}
      env:
        RUSTFLAGS: "-C target-cpu=x86-64"
      run: cargo build --release --features "load_magic deterministic_zobrist"

    - name: Prepare Package
      shell: bash
      run: |
        mkdir -p release/vantage
        cp ${{ matrix.binary_path }} release/vantage/${{ matrix.exe_name }}
        cp README.md release/vantage/
        # Copy the book (Check if it exists first to avoid crashing if you forget it)
        if [ -f "backend/book.bin" ]; then
          cp backend/book.bin release/vantage/
        elif [ -f "book.bin" ]; then
          cp book.bin release/vantage/
        else
          echo "WARNING: book.bin not found in root or backend!"
        fi

    - name: Compress (Windows)
      if: matrix.os == 'windows-latest'
      uses: thedoctor0/zip-release@0.7.6
      with:
        type: 'zip'
        filename: ${{ matrix.artifact_name }}
        directory: 'release'
        path: 'vantage'

    - name: Compress (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd release
        tar -czvf ${{ matrix.artifact_name }} vantage

    - name: Publish Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/${{ matrix.artifact_name }}
        draft: true
        prerelease: false
        generate_release_notes: true