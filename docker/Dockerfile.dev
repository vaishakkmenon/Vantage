# =============================================================================
# Vantage Chess Engine - Development Environment
# =============================================================================
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC

# -----------------------------------------------------------------------------
# 1. System Packages
# -----------------------------------------------------------------------------
# [NETWORK FIX] Switch to US mirrors to fix "Connection Refused" errors
RUN sed -i 's|http://archive.ubuntu.com/ubuntu/|http://us.archive.ubuntu.com/ubuntu/|g' /etc/apt/sources.list.d/ubuntu.sources \
    && apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    pkg-config \
    # Compilers for Engines
    clang \
    # [CRITICAL FIX] Required for Ethereal PGO build
    libclang-rt-18-dev \
    llvm \
    llvm-runtime \
    git \
    curl \
    wget \
    unzip \
    ca-certificates \
    vim \
    nano \
    gdb \
    valgrind \
    python3 \
    python3-venv \
    python3-pip \
    python3-dev \
    sqlite3 \
    libsqlite3-dev \
    supervisor \
    openssh-client \
    rsync \
    netcat-openbsd \
    crafty \
    phalanx \
    fairymax \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# 2. Chess Engines
# -----------------------------------------------------------------------------
RUN mkdir -p /engines

# Stockfish 16
RUN cd /tmp \
    && wget https://github.com/official-stockfish/Stockfish/releases/download/sf_16/stockfish-ubuntu-x86-64-avx2.tar \
    && tar -xf stockfish-ubuntu-x86-64-avx2.tar \
    && mv stockfish/stockfish-ubuntu-x86-64-avx2 /engines/stockfish \
    && chmod +x /engines/stockfish \
    && rm -rf /tmp/stockfish*

# Ethereal (Source Build)
RUN cd /tmp \
    && git clone https://github.com/AndyGrant/Ethereal.git \
    && cd Ethereal/src \
    && make -j$(nproc) \
    && mv Ethereal /engines/ethereal \
    && chmod +x /engines/ethereal \
    && rm -rf /tmp/Ethereal

# TSCP 1.81 (Source Build)
# [FIXED PATH] cd into the nested folder tscp/tscp181
RUN cd /tmp \
    && wget http://www.tckerrigan.com/Chess/TSCP/tscp181.zip \
    && unzip tscp181.zip -d tscp \
    && cd tscp/tscp181 \
    && gcc *.c -o tscp -O3 \
    && mv tscp /engines/tscp \
    && chmod +x /engines/tscp \
    && rm -rf /tmp/tscp*

# Fruit 2.1 (Source Build)
# https://www.collinsdictionary.com/us/dictionary/english/fix Uses the Warpten mirror (Public Preservation of v2.1)
RUN cd /tmp \
    && git clone https://github.com/Warpten/Fruit-2.1 \
    && cd Fruit-2.1/src \
    && make -j$(nproc) \
    && mv fruit /engines/fruit \
    && chmod +x /engines/fruit \
    && rm -rf /tmp/Fruit-2.1

# Consolidate System Engines
RUN cp /usr/games/crafty /engines/crafty \
    && cp /usr/games/phalanx /engines/phalanx \
    && cp /usr/games/fairymax /engines/fairymax \
    && chmod +x /engines/*

# -----------------------------------------------------------------------------
# 3. Testing Tools
# -----------------------------------------------------------------------------

# Cutechess-CLI dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    qtbase5-dev \
    libqt5svg5-dev \
    && rm -rf /var/lib/apt/lists/*

# Cutechess-CLI Build
RUN cd /tmp \
    && git clone --depth 1 --branch v1.4.0 https://github.com/cutechess/cutechess.git \
    && cd cutechess \
    && cmake -B build -DCMAKE_BUILD_TYPE=Release -DWITH_TESTS=OFF \
    && cmake --build build -j$(nproc) \
    && cp build/cutechess-cli /usr/local/bin/ \
    && chmod +x /usr/local/bin/cutechess-cli \
    && rm -rf /tmp/cutechess

# Ordo
RUN cd /tmp \
    && git clone --depth 1 https://github.com/michiguel/Ordo.git \
    && cd Ordo \
    && make \
    && cp ordo /usr/local/bin/ \
    && rm -rf /tmp/Ordo

# -----------------------------------------------------------------------------
# 4. Node.js Environment
# -----------------------------------------------------------------------------
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g typescript @anthropic-ai/claude-code

# -----------------------------------------------------------------------------
# 5. Rust Environment
# -----------------------------------------------------------------------------
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable \
    && echo 'source /root/.cargo/env' >> /root/.bashrc

ENV PATH="/root/.cargo/bin:${PATH}"

RUN rustup component add clippy rustfmt \
    && cargo install cargo-watch

# -----------------------------------------------------------------------------
# 6. Python Environment
# -----------------------------------------------------------------------------
RUN python3 -m venv /venv
ENV PATH="/venv/bin:${PATH}"
ENV VIRTUAL_ENV="/venv"

RUN pip install --upgrade pip && pip install \
    black flake8 mypy pytest pytest-timeout \
    pandas sqlalchemy click rich pyyaml toml python-chess

# -----------------------------------------------------------------------------
# 7. Final Configuration
# -----------------------------------------------------------------------------
RUN mkdir -p /engines/anchors \
    && mkdir -p /engines/candidates \
    && mkdir -p /openings \
    && mkdir -p /results/pgn \
    && mkdir -p /results/db

RUN cd /openings \
    && wget -q https://raw.githubusercontent.com/official-stockfish/books/master/2moves_v2.pgn \
    || echo "# Opening book download failed" > /openings/README.txt

ENV PATH="/engines:/usr/games:${PATH}"
ENV ENGINES_DIR="/engines"
ENV OPENINGS_DIR="/openings"
ENV RESULTS_DIR="/results"

WORKDIR /workspace
VOLUME ["/workspace"]

ENTRYPOINT ["bash"]